{% extends 'base.html' %}

{% block content %}
{% load cart %}
{% load custom_filter %}

<div class="container py-5">
  <div class="card card-custom p-4">
    <h2 class="display-6 mb-4">Your Orders</h2>
    <hr>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>S.No.</th>
            <th>Image</th>
            <th>Product</th>
            <th>Date</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Invoice</th>
            <th>Status</th>
            <th>Tracking</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr>
            <td>{{forloop.counter}}</td>
            <td>
              <a href="/product/{{order.product.id}}">
                <img style="height: 60px; width: 60px; object-fit: cover;" class="rounded shadow-sm"
                  src="{{order.product.image.url}}" alt="{{order.product.name}}">
              </a>
            </td>
            <td class="fw-bold">
              <a href="/product/{{order.product.id}}" class="text-decoration-none text-dark">
                {{order.product.name}}
              </a>
            </td>
            <td>{{order.date}}</td>
            <td>{{order.price|currency}}</td>
            <td>{{order.quantity}}</td>
            <td class="fw-bold text-primary-custom">{{order.quantity|multiply:order.price|currency}}</td>
            <td class="text-nowrap">
              {% if order.invoice_id %}
              <a href="/invoice/{{order.invoice_id}}" class="btn btn-sm btn-outline-primary" target="_blank"
                title="Invoice">
                <i class="fas fa-file-invoice"></i>
              </a>
              {% endif %}
            </td>
            <td style="min-width: 150px;">
              <span
                class="badge rounded-pill {% if order.status == 'Delivered' %}bg-success{% elif order.status == 'Cancel' %}bg-danger{% else %}bg-primary{% endif %} mb-0">
                {{order.status}}
              </span>
            </td>
            <td>
              <button class="btn btn-sm btn-light border shadow-sm w-100 fw-bold text-primary-custom" type="button"
                data-bs-toggle="collapse" data-bs-target="#trackDetails{{order.id}}" aria-expanded="false">
                Track <i class="fas fa-chevron-down ms-1"></i>
              </button>
            </td>
          </tr>

          <!-- Collapsible Detail Row -->
          <tr>
            <td colspan="10" class="p-0 border-0">
              <div class="collapse bg-light" id="trackDetails{{order.id}}">
                <div class="p-4">
                  <div class="position-relative m-4">
                    <div class="progress" style="height: 2px;">
                      <div class="progress-bar bg-success" role="progressbar"
                        style="width: {% if order.status == 'Delivered' %}100%{% elif order.status == 'On The Way' %}75%{% elif order.status == 'Packed' %}50%{% elif order.status == 'Accepted' %}25%{% else %}0%{% endif %};"
                        aria-valuenow="50" aria-valuemin="0" aria-valuemix="100"></div>
                    </div>

                    <!-- Step 1: Placed -->
                    <div class="position-absolute top-0 start-0 translate-middle btn btn-sm btn-primary rounded-pill"
                      style="width: 2rem; height:2rem;">1</div>
                    <div class="position-absolute top-0 start-0 translate-middle-x mt-4 small fw-bold">Placed</div>

                    <!-- Step 2: Accepted -->
                    <div
                      class="position-absolute top-0 start-25 translate-middle btn btn-sm {% if order.status in 'Accepted,Packed,On The Way,Delivered' %}btn-primary{% else %}btn-secondary{% endif %} rounded-pill"
                      style="width: 2rem; height:2rem; left: 25%;">2</div>
                    <div class="position-absolute top-0 start-25 translate-middle-x mt-4 small fw-bold"
                      style="left: 25%;">Accepted</div>

                    <!-- Step 3: Packed -->
                    <div
                      class="position-absolute top-0 start-50 translate-middle btn btn-sm {% if order.status in 'Packed,On The Way,Delivered' %}btn-primary{% else %}btn-secondary{% endif %} rounded-pill"
                      style="width: 2rem; height:2rem; left: 50%;">3</div>
                    <div class="position-absolute top-0 start-50 translate-middle-x mt-4 small fw-bold"
                      style="left: 50%;">Packed</div>

                    <!-- Step 4: On The Way -->
                    <div
                      class="position-absolute top-0 start-75 translate-middle btn btn-sm {% if order.status in 'On The Way,Delivered' %}btn-primary{% else %}btn-secondary{% endif %} rounded-pill"
                      style="width: 2rem; height:2rem; left: 75%;">4</div>
                    <div class="position-absolute top-0 start-75 translate-middle-x mt-4 small fw-bold"
                      style="left: 75%;">Shipped</div>

                    <!-- Step 5: Delivered -->
                    <div
                      class="position-absolute top-0 start-100 translate-middle btn btn-sm {% if order.status == 'Delivered' %}btn-primary{% else %}btn-secondary{% endif %} rounded-pill"
                      style="width: 2rem; height:2rem;">5</div>
                    <div class="position-absolute top-0 start-100 translate-middle-x mt-4 small fw-bold">Delivered</div>
                  </div>
                  <div class="mt-5 text-center text-muted small">
                    {% if order.status == 'Placed' %}
                    Order placed on {{order.date}}. Waiting, for seller confirmation.
                    {% elif order.status == 'Accepted' %}
                    Order confirmed! We are preparing your item.
                    {% elif order.status == 'Packed' %}
                    Item is packed and ready for dispatch.
                    {% elif order.status == 'On The Way' %}
                    Your order is on the way! Watch out for delivery.
                    {% elif order.status == 'Delivered' %}
                    Delivered successfully. Enjoy your product!
                    {% endif %}
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-center py-5">
              <h4>No orders found</h4>
              <a href="/store" class="btn btn-primary-custom mt-3">Start Shopping</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}