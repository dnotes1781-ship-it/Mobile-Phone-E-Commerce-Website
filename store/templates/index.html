{% extends 'base.html' %}

{% block content %}

{% load cart %}
{% load custom_filter %}

<!-- Hero/Carousel Section -->
<div class="container-fluid p-0 mb-5">
  <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000" data-bs-pause="hover" data-bs-keyboard="true">
    <div class="carousel-indicators">
      <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
      <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
      <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
      <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
      <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="4" aria-label="Slide 5"></button>
      <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="5" aria-label="Slide 6"></button>
      <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="6" aria-label="Slide 7"></button>
    </div>
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=1350&q=80" loading="lazy" class="d-block w-100" style="height: min(60vh, 500px); object-fit: cover;" alt="Smartphone 1">
        <div class="carousel-caption d-none d-sm-block">
          <div class="bg-dark bg-opacity-50 p-3 rounded">
            <h5 class="mb-1">Premium Smartphones</h5>
            <p class="mb-0">Discover the latest technology with our exclusive collection.</p>
          </div>
        </div>
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1512496015851-a90fb38ba796?auto=format&fit=crop&w=1350&q=80" loading="lazy" class="d-block w-100" style="height: min(60vh, 500px); object-fit: cover;" alt="Smartphone 2">
        <div class="carousel-caption d-none d-sm-block">
          <div class="bg-dark bg-opacity-50 p-3 rounded">
            <h5 class="mb-1">Unbeatable Prices</h5>
            <p class="mb-0">Get the best deals on top brands today.</p>
          </div>
        </div>
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1484704849700-f032a568e944?auto=format&fit=crop&w=1350&q=80" loading="lazy" class="d-block w-100" style="height: min(60vh, 500px); object-fit: cover;" alt="Smartphone 3">
        <div class="carousel-caption d-none d-sm-block">
          <div class="bg-dark bg-opacity-50 p-3 rounded">
            <h5 class="mb-1">New Arrivals</h5>
            <p class="mb-0">Check out the newest additions to our store.</p>
          </div>
        </div>
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1510557880182-3bdcc9b6b2d6?auto=format&fit=crop&w=1350&q=80" loading="lazy" class="d-block w-100" style="height: min(60vh, 500px); object-fit: cover;" alt="Smartphone 4">
        <div class="carousel-caption d-none d-sm-block">
          <div class="bg-dark bg-opacity-50 p-3 rounded">
            <h5 class="mb-1">Featured Deals</h5>
            <p class="mb-0">Limited time offers on selected models.</p>
          </div>
        </div>
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1524678606370-a47ad25cb82a?auto=format&fit=crop&w=1350&q=80" loading="lazy" class="d-block w-100" style="height: min(60vh, 500px); object-fit: cover;" alt="Smartphone 5">
        <div class="carousel-caption d-none d-sm-block">
          <div class="bg-dark bg-opacity-50 p-3 rounded">
            <h5 class="mb-1">Top Rated</h5>
            <p class="mb-0">Customer-favorite models and accessories.</p>
          </div>
        </div>
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&w=1350&q=80" loading="lazy" class="d-block w-100" style="height: min(60vh, 500px); object-fit: cover;" alt="Smartphone 6">
        <div class="carousel-caption d-none d-sm-block">
          <div class="bg-dark bg-opacity-50 p-3 rounded">
            <h5 class="mb-1">Accessories</h5>
            <p class="mb-0">Complement your purchase with top accessories.</p>
          </div>
        </div>
      </div>
      <div class="carousel-item">
        <img src="https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?auto=format&fit=crop&w=1350&q=80" loading="lazy" class="d-block w-100" style="height: min(60vh, 500px); object-fit: cover;" alt="Smartphone 7">
        <div class="carousel-caption d-none d-sm-block">
          <div class="bg-dark bg-opacity-50 p-3 rounded">
            <h5 class="mb-1">Shop Now</h5>
            <p class="mb-0">Wide selection at competitive prices.</p>
          </div>
        </div>
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>
</div>

<div class="container mb-5">
  <div class="row align-items-start">

    <!-- Sidebar Filters -->
    <!-- Sidebar Filters -->
    <div class="col-lg-3 mb-4">
      <div class="sticky-top" style="top: 90px; z-index: 1;">
        <!-- Categories -->
        <div class="card card-custom p-3" style="height: auto;">
          <h5 class="mb-3">Categories</h5>
          <div class="list-group list-group-flush">
            <a href="/store#products"
              class="list-group-item list-group-item-action {% if not request.GET.category %}active{% endif %}">All
              Products</a>
            {% for category in categories %}
            <a href="/store?category={{category.id}}#products"
              class="list-group-item list-group-item-action {% if request.GET.category == category.id|stringformat:'s' %}active{% endif %}">
              {{category.name}}
            </a>
            {% endfor %}
          </div>
        </div>

        <!-- Price Filter -->
        <div class="card card-custom p-3 mt-4">
          <h5 class="mb-3">Filter by Price</h5>
          <form action="/store" method="GET">
            <!-- Preserve existing filters -->
            {% if request.GET.category %}
            <input type="hidden" name="category" value="{{request.GET.category}}">
            {% endif %}
            {% if request.GET.q %}
            <input type="hidden" name="q" value="{{request.GET.q}}">
            {% endif %}

            <!-- Range Slider -->
            <div class="price-input-container">
              <div class="d-flex justify-content-between mb-2">
                <span class="small fw-bold text-muted">Range:</span>
                <span class="small fw-bold text-primary-custom" id="price-range-label">
                  <!-- JS updates this -->
                  ₹{{request.GET.min_price|default:min_price_limit}} -
                  ₹{{request.GET.max_price|default:max_price_limit}}
                </span>
              </div>

              <div class="range-slider-wrapper position-relative mb-3"
                style="height: 5px; background: #ddd; border-radius: 5px;">
                <div class="progress-bar position-absolute"
                  style="height: 100%; background: var(--primary-color); border-radius: 5px; left: 0%; right: 0%;">
                </div>
                <input type="range" class="range-min position-absolute w-100" min="{{min_price_limit}}"
                  max="{{max_price_limit}}" value="{{request.GET.min_price|default:min_price_limit}}" step="100"
                  name="min_price" style="top: -5px;">
                <input type="range" class="range-max position-absolute w-100" min="{{min_price_limit}}"
                  max="{{max_price_limit}}" value="{{request.GET.max_price|default:max_price_limit}}" step="100"
                  name="max_price" style="top: -5px;">
              </div>
            </div>

            <button type="submit" class="btn btn-primary-custom w-100 btn-sm">Apply Filter</button>
          </form>
        </div>
      </div>
    </div>



    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const rangeInput = document.querySelectorAll(".range-slider-wrapper input");
        const progress = document.querySelector(".range-slider-wrapper .progress-bar");
        const label = document.getElementById("price-range-label");
        const minVal = parseInt(rangeInput[0].getAttribute("min"));
        const maxVal = parseInt(rangeInput[0].getAttribute("max"));

        function updateProgress() {
          let minParam = parseInt(rangeInput[0].value);
          let maxParam = parseInt(rangeInput[1].value);

          // Prevent crossover
          if (maxParam - minParam < 0) {
            if (event.target.className.includes("range-min")) {
              rangeInput[0].value = maxParam;
              minParam = maxParam;
            } else {
              rangeInput[1].value = minParam;
              maxParam = minParam;
            }
          }

          label.innerText = `₹${minParam} - ₹${maxParam}`;

          progress.style.left = ((minParam - minVal) / (maxVal - minVal)) * 100 + "%";
          progress.style.right = 100 - ((maxParam - minVal) / (maxVal - minVal)) * 100 + "%";
        }

        rangeInput.forEach(input => {
          input.addEventListener("input", updateProgress);
        });

        // Init
        updateProgress();
      });
    </script>

    <!-- Products Grid -->
    <div id='products' class="col-lg-9 mt-1">
      <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for product in products %}
        <div class="col" id="{{product.id}}">
          <div class="card card-custom h-100">
            <a href="/product/{{product.id}}" class="text-decoration-none stretched-link">
              <img src="{{product.image.url}}" class="card-img-top card-img-top-custom" alt="{{product.name}}">
            </a>
            <div class="card-body card-body-custom d-flex flex-column text-center">
              <h5 class="card-title mb-2">{{product.name}}</h5>
              <p class="card-text text-primary-custom fw-bold fs-5 mb-4">{{product.price|currency}}</p>

              <div id="product-actions-{{product.id}}" class="mt-auto position-relative" style="z-index: 2;">
                {% if product|is_in_cart:request.session.cart %}
                <div class="d-flex justify-content-between align-items-center bg-white rounded p-2 border">
                  <form action="/#{{product.id}}" method="post" class="ajax-cart-form">
                    {% csrf_token %}
                    <input hidden type="text" name='product' value='{{product.id}}'>
                    <input hidden type="text" name='remove' value='True'>
                    <button type="submit" class="btn btn-sm btn-outline-secondary border-0"><i
                        class="fas fa-minus"></i></button>
                  </form>
                  <span class="fw-bold">{{product|cart_quantity:request.session.cart}}</span>
                  <form action="/#{{product.id}}" method="post" class="ajax-cart-form">
                    {% csrf_token %}
                    <input hidden type="text" name='product' value='{{product.id}}'>
                    <button type="submit" class="btn btn-sm btn-outline-primary border-0"><i
                        class="fas fa-plus"></i></button>
                  </form>
                </div>
                {% else %}
                <form action="/#{{product.id}}" method="POST" class="d-grid ajax-cart-form">
                  {% csrf_token %}
                  <input hidden type="text" name='product' value='{{product.id}}'>
                  <button type="submit" class="btn btn-primary-custom w-100">Add To Cart</button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>



{% endblock %}